<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<link rel="stylesheet" href="styles.css">
<title>SIDIA's Face Capturing</title>

</head>

<body>
    <div class='centered' style="margin-top: 20px; margin-bottom: 20px">
        <h1 class='title'>Porfavor mexa sua cabeca em varios sentidos. Se
            aproxime e fique longe da camera.</h1>
    </div>


<div class='centered'>
    <canvas id='bb_canvas'></canvas>
    <video autoplay="true" id="videoElement">
    </video>
</div>

<div class='centered' style="margin-top: 20px; margin-bottom: 20px">
    <p id="hold_secs_message" style="font-size:20px; display:none;">Porfavor aguarde pelo menos <span id="secs"></span> segundos.</p>
    <h1 id="end_message" style="display: none">Obrigado pela sua cooperacao !!!
        Compartilhe o link !! e volte sempre que quiser continuar
        coolaborando</h1>
</div>

<!--<script type="text/javascript"
    src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>-->

<script>

    var cam_open = false;
    var secs = 30;
    var ws = new WebSocket("ws://localhost:5000/detect");
    var wsopen = false

    ws.onopen = function() {
        wsopen = true;
    };

    ws.onmessage = function(evt)
        {
            var data = JSON.parse(evt.data);
            console.log("Detected ...");
            console.log(data);

            var canvas = document.getElementById("bb_canvas");
            var cw = canvas.width;
            var ch = canvas.height;
            canvas.width = 0;
            canvas.height = 0;
            canvas.width = cw;
            canvas.height = ch;
            var w_fact = canvas.width / canvas.offsetWidth;
            var h_fact = canvas.height / canvas.offsetHeight;
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = 'yellow';
            ctx.rect(data['x'] * w_fact, data['y'] * h_fact, data['w'] * w_fact, data['h'] * h_fact);
            ctx.stroke();

        };

    var video = document.getElementById("videoElement");

    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({video: true})
        .then(function(stream) {

            document.getElementById('hold_secs_message').style.display='block';
            cam_open = true;
            video.srcObject = stream;
        })
        .catch(function(err0r) {
            console.log("Something went wrong!");});
    }

    function count_down_and_show(){

        if(cam_open){
            document.getElementById('hold_secs_message').style.display = 'block';
            document.getElementById('secs').innerHTML = secs;
            if(secs > 0){
                secs --;
            }
        }

        if(secs == 15){
            document.getElementById('end_message').style.display = 'block';
        }

    }

    function dataURLtoBlob(dataURL) {

        var binary = atob(dataURL.split(',')[1]);
        var array = [];
        for(var i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], {type: 'image/png'});
    }

    function captureImage() {

        var video = document.getElementById("videoElement");

        var canvas = document.createElement("canvas");
        canvas.width= video.offsetWidth;
        canvas.height= video.offsetHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width,
        canvas.height);
        var data_url = canvas.toDataURL();

        return data_url;
     };

    function main(){
        console.log('Capturing and sending ...')
        var data_url = captureImage();
        var image_blob = dataURLtoBlob(data_url);
        ws.send(image_blob);
    }

    setInterval(main, 800);
    setInterval(count_down_and_show, 1000);


</script>
</body>
</html>
